@page
@model shop_hubLaps.Areas.Identity.Pages.Account.Manage.OrdersModel

@{
    ViewData["Title"] = "Lịch sử mua hàng";
    ViewData["ActivePage"] = ManageNavPages.Orders;
}

<div class="container mt-4">
    <h4 class="mt-4">Lịch sử mua hàng</h4>
    @if (Model.ViewModel.DonHangs == null || !Model.ViewModel.DonHangs.Any())
    {
        <div class="alert alert-info">
            Bạn chưa có đơn hàng nào.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-striped table-bordered align-middle">
                <thead>
                    <tr>
                        <th>Mã đơn hàng</th>
                        <th>Ngày đặt</th>
                        <th>Tổng tiền</th>
                        <th>Trạng thái</th>
                        <th>Tên Laptop</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    @foreach (var order in Model.ViewModel.DonHangs.Take(6))
                    {
                        <tr>
                            <td>@order.madon</td>
                            <td>@(order.ngaydat.HasValue ? order.ngaydat.Value.ToString("dd/MM/yyyy HH:mm") : "N/A")</td>
                            <td>@order.gia.ToString("C0", new System.Globalization.CultureInfo("vi-VN"))</td>
                            <td>
                                @switch (order.tinhtrang)
                                {
                                    case "COMPLETED":
                                        <span class="badge bg-success">Hoàn thành</span>
                                        break;
                                    case "REFUNDED":
                                        <span class="badge bg-secondary">Đã hoàn tiền</span>
                                        break;
                                    case "CANCELLED":
                                        <span class="badge bg-danger">Đã hủy</span>
                                        break;
                                    case "DELIVERED":
                                        <span class="badge bg-primary">Đã giao hàng thành công</span>
                                        break;
                                    case "SHIPPED":
                                        <span class="badge bg-info">Đã giao hàng</span>
                                        break;
                                    case "PENDING":
                                        <span class="badge bg-warning">Chờ xử lý</span>
                                        break;
                                    case "PROCESSING":
                                        <span class="badge bg-warning">Đang xử lý</span>
                                        break;
                                    case "CART":
                                        <span class="badge bg-light text-dark">Giỏ hàng</span>
                                        break;
                                    default:
                                        <span class="badge bg-dark">Không xác định</span>
                                        break;
                                }
                            </td>
                            <td>
                                @foreach (var detail in order.ChiTietDonHangs)
                                {
                                    <p>@detail.Laptop.tenlaptop</p>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Nút Xem thêm -->
        @if (Model.ViewModel.DonHangs.Count() > 6)
        {
            <div class="text-center">
                <button id="showMore" class="btn btn-primary" onclick="showMoreOrders()">Xem thêm</button>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        // JavaScript để hiển thị thêm đơn hàng khi bấm nút "Xem thêm"
        function showMoreOrders() {
            // Lấy tất cả các đơn hàng từ ViewModel
            const allOrders = @Html.Raw(Json.Serialize(Model.ViewModel.DonHangs));

            // Kiểm tra xem dữ liệu có được truyền đúng không
            console.log(allOrders); // In ra để kiểm tra

            // Xóa nút Xem thêm sau khi nhấn
            document.getElementById('showMore').style.display = 'none';

            // Lấy body của bảng để thêm các hàng mới
            const tableBody = document.getElementById('ordersTableBody');

                // Kiểm tra nếu allOrders có dữ liệu
                if (Array.isArray(allOrders)) {
                    // Thêm các đơn hàng còn lại vào bảng
                    allOrders.slice(6).forEach(order => {
                    // Kiểm tra ChiTietDonHangs có phải là mảng hợp lệ không
                    if (Array.isArray(order.ChiTietDonHangs)) {
                        order.ChiTietDonHangs.forEach(detail => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${order.madon}</td>
                                    <td>${order.ngaydat ? new Date(order.ngaydat).toLocaleString('vi-VN') : 'N/A'}</td>
                                    <td>${order.gia.toLocaleString('vi-VN', { style: 'currency', currency: 'VND' })}</td>
                                    <td>${order.tinhtrang}</td>
                                    <td>${detail.Laptop.tenlaptop}</td>
                                `;
                                tableBody.appendChild(row);
                            });
                        }
                    });
                } else {
                    console.error('Dữ liệu đơn hàng không hợp lệ!');
                }
            }
    </script>
}
